---
title: 设备树规范v0.2
tags: Linux内核
---

------

&emsp;&emsp;<font color=blue>**_版权声明_**</font>：本文翻译自<font color=blue>[设备树官网](https://www.devicetree.org/)。</font><font color=red>未经作者允许，<font color=blue>严禁用于商业出版</font>，否则追究法律责任。网络转载请注明出处，这是对原创者的起码的尊重！！！</font>

------

<style>table{word-break:initial;}</style>

**版权**
版权所有2008,2011 Power.org，Inc。
版权所有2008,2011 Freescale Semiconductor，Inc。
版权所有2008,2011 International Business Machines Corporation。
版权所有2016,2017 Linaro，Ltd。
版权所有2016,2017 Arm，Ltd。

Linaro和devicetree.org文字标记以及Linaro和devicetree.org徽标及相关标记是Linaro Ltd.许可的商标和服务标记。本文档某些元素的实施可能需要第三方知识产权获得许可，包括但不限于专利权。 Linaro及其会员不以任何方式对识别或未能识别的任何或所有第三方知识产权负责。

Power Architecture和Power.org文字标记以及Power和Power.org徽标及相关标记是Power.org许可的商标和服务标记。 本文档某些元素的实施可能需要第三方知识产权获得许可，包括但不限于专利权。Power.org及其会员不以任何方式对识别或未能识别的任何或所有第三方知识产权负责。

本规范“按原样”提供，不作任何形式的保证，包括但不限于任何非侵权，适销性或适用于特定用途的表述或暗示性保证。 在任何情况下，linaro或任何linaro成员均不对任何直接，间接，特殊，示范，惩罚或性损性后果害承担责任，包括但不限于利润损失，即使被告知可能发生此类损害。


与本文件或其条款或条件有关的问题应提交至：
Linaro, Ltd
Harston Mill,
Royston Road,
Harston CB22 7GG
Attn： Devicetree.org Board Secretary


**许可证信息**

根据Apache许可证2.0版获得许可;除非符合许可，否则您不得使用此文件。您可以在<http://www.apache.org/licenses/LICENSE-2.0>获取许可证的副本

除非适用的法律要求书面同意，否则，该许可证下的软件分发按“原样”分发，不附带任何明示或暗示的保证或条件。有关该许可证下的特定语言许可和权限，请参阅许可证。

**致谢**
devicetree.org技术指导委员会要感谢许多做出贡献的个人和公司，他们通过写作，技术讨论和评论来对本规范的制定做出了贡献。

我们要感谢开发和发布ePAPR的power.org平台架构技术小组委员会。ePAPR被用作本文件的起点。

Devicetree规范的重要概念基于Open Firmware Working Group所做的工作，该工作组开发了IEEE-1275的绑定（binding）。 我们要感谢他们的贡献。

我们还要感谢开发和实现扁平设备树概念的PowerPC和ARM Linux社区的贡献。

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;表1 版本历史
|版本|时间|描述|
|：--|：--|：--|
|0.1|2016-05-24|最初的预发布版本。导入ePAPR到结构文本格式，溢出 Power ISA 特定元素。
|0.2|2017-12-20|增加更多推荐的通用节点名<br />增加了中断扩展<br />额外的phy times<br />填写源语言章节中的详细信息<br />编辑变化<br />添加了更改栏版本到发布文档

# 1 介绍
# 1.1 目的和范围

为了初始化和引导计算机系统，各种软件组件进行交互。在将控制权交给软件（如操作系统，引导加载程序或管理程序（hypervisor））之前，固件可能会执行系统硬件的低级初始化。反过来，引导加载程序和管理程序可以加载和转移控制到操作系统。标准，一致的接口和约定有助于这些软件组件之间的交互。在该文档中，术语引导程序一般地指初始化系统状态并执行称为客户端程序的另一软件组件的软件组件。引导程序的示例包括：固件，引导加载程序和管理程序。客户端程序的示例包括：引导加载程序，管理程序，操作系统和专用程序。一个软件可以既是客户端程序又是引导程序（例如，管理程序）。

设备树规范（DTSpec）为客户端程序接口定义提供了完整的引导程序，系统要求最低，这有助于各种系统开发。该规范是针对嵌入式系统。 嵌入式系统通常由系统硬件，操作系统和应用软件组成，这些软件是定制设计用于执行固定的特定任务集。 这与通用计算机不同，通用计算机为具有各种软件和I / O设备的用户设计。 嵌入式系统的其他特性可能包括：

*  一组固定的I / O设备，可能是针对应用程序高度定制的
*  针对尺寸和成本进行优化的系统板
*  有限的用户接口
*  资源限制，如有限的内存和有限的非易失性存储
*  实时约束
*  使用各种操作系统，包括Linux，实时操作系统以及自定义或专有操作系统

**本文件的组织**

*  第1章介绍了DTSpec指定的体系结构。
*  第2章介绍了devicetree概念并描述了其逻辑结构和标准属性。
*  第3章指定了DTSpec兼容设备所需的基本设备节点集的定义。
*  第4章介绍了某类设备和特定设备类型的设备绑定（binding）。
*  第5章指定了设备的DTB编码。
*  第6章指定DTS源语言。

**本文档中使用的约定**
“shall”用于表示严格遵守的强制性要求，以符合标准和不允许偏差（shall等于要求）。

“should”一词用于表示在几种可能性中，有一个特别适合因而被推荐，不提及或排除其他可能性; 或者某种行动方案是首选但不一定是必需的; 或者（以否定的形式）某种行为被弃用但不被禁止（should等于推荐）。

“may”一词用于表示在标准范围内允许的动作（may等于允许）。

设备树构造的示例经常以Devicetree Syntax形式显示。 有关此语法的概述，请参见第6节。

## 1.2 与IEEE1275^TM^和ePAPR的关系
DTSpec与IEEE 1275 Open Firmware标准松散相关（松散相关是紧密相关的反义词）。IEEE1275标准是引导（初始化配置）固件的标准：核心要求和实践[^IEEE1275]。

[^IEEE1275]:Boot (Initialization Configuration) Firmware： Core Requirements and Practices, 1994, This is the core standard (also known as IEEE 1275) that defines the devicetree concept adopted by the DTSpec and ePAPR. It is available from Global Engineering (http://global.ihs.com/).

最初的IEEE 1275规范及其衍生产品如CHRP [^CHRP]和PAPR [^PAPR]解决了通用计算机的问题，例如单个版本的操作系统如何在同一系列中的几台不同计算机上工作以及从用户安装的I / O设备加载操作系统。

[^CHRP]: PowerPC Microprocessor Common Hardware Reference Platform (CHRP) Binding, Version 1.8, Open Firmware Working Group, 1998(http://playground.sun.com/1275/bindings/chrp/chrp1_8a.ps). This document specifies the properties for Open PIC-compatible interrupt controllers.

[^PAPR]: Power.org Standard for Power Architecture Platform Requirements, power.org

由于嵌入式系统的性质，开放式通用计算机所面临的一些问题不会发生。 DTSpec中省略的IEEE 1275规范的显著特征包括：

* 插件设备驱动程序
* FCode
* 基于Forth的可编程Open Firmware用户界面
* FCode调试
* 操作系统调试
 
 从IEEE 1275保留的是来自设备树架构的概念，通过该概念，引导程序可以描述并将系统硬件信息传送到客户端程序，从而消除了客户端程序具有系统硬件的硬编码（hard-code）描述的需要。
 
该规范部分取代了ePAPR [^EPAPR]规范。 ePAPR记录了Power ISA如何使用设备树，并涵盖了一般概念以及Power ISA特定绑定（binding）。 本文档的文本源自ePAPR，但要么删除特定于体系结构的绑定（binding），要么将它们移动到附录中。


[^EPAPR]:Power.org Standard for Embedded Power Architecture Platform Requirements, power.org, 2011, https://www.power.org/documentation/power-org-standard-for-embedded-power-architecture-platform-requirements-epapr-v1-1-2/

## 1.3 32位和64位支持
DTSpec支持具有32位和64位寻址功能的CPU。 在适用的情况下，DTSpec的各个部分描述了32位和64位寻址的任何要求或注意事项。

## 1.4 术语定义
**AMP** 非对称多处理。计算机可用的CPU被分区为组，每个组运行不同的操作系统映像。 CPU可能（may）相同也可能不相同。

**引导CPU（boot CPU）** 引导程序指向客户端程序入口点的第一个CPU。

**Book III-E** 嵌入式环境。 Power ISA的一部分，定义了嵌入式Power处理器实现中使用的监控指令和相关设施。

**引导程序（boot program）** 通常指初始化系统状态并执行另一个软件组件的软件组件。引导程序的示例包括：固件，引导加载程序和管理程序。

**客户程序（client program）**  典型的客户程序包含应用程序或操作系统软件。客户端程序的示例包括：引导加载程序，管理程序，操作系统和专用程序。

**cell** 32位信息单元（cell）。

**DMA** 直接内存访问。

**DTB** devicetree blob。设备树的二进制形式。

**DTC** 设备树编译器，用于从DTS文件创建DTB文件的一个开源工具。

**DTS** Devicetree syntax。设备树的文本表示。参见附录A 设备树源文件格式（版本1）

**有效地址（effective addres）**  由处理器存储访问或分支指令计算的内存地址。


**物理地址（physical address）** 处理器用于访问外部设备的地址，典型如：内存控制器。

**Power ISA** Power 指令集架构。

**中断说明符（interrupt specifier）**  描述中断的属性值。 典型地，包扩中断号、灵敏度、触发机制。

**次级CPU（secondary CPU ）** 除引导CPU之外的属于客户程序的CPU。

**SMP** 对称多处理。 一种计算机体系结构，其中两个或多个相同的CPU可以共享内存 和IO并在单个操作系统下运行。

**SoC** 片上系统。 单个计算机芯片集成了一个或多个CPU核心以及许多其他外围设备。

**单元（cell）地址（unit address）**  节点名的一部分，指定节点在父节点的地址空间中的地址。

**静态CPU（quiescent CPU）** 静态CPU是一种状态，它不会干扰其他CPU正常操作，也不会被其它正在运行的CPU的正常操作影响，除非用显式方法 启用或重新启用静态CPU，

# 2 设备树
## 2.1 概述
DTSpec指定一种设备树的构造来描述系统硬件。引导程序将设备加载到客户程序的内存中，并将指向设备树的指针传递给客户程序。

本章描述了设备树的逻辑结构，并指定了一组用于描述设备树节点的基本属性集。第3章要求符合DTSpec规范的的设备树需要的某些设备节点。第6章描述了DSpec定义的设备绑定（binding）——表示某些设备类型或类别的要求。 第8章描述了设备树的内存中编码。

设备树是具有描述系统中的设备的节点的数据结构。每个节点都有属性/值对，用于描述所表示设备的特征。 每个节点只有一个父节点，但根节点除外，它没有父节点。

符合设备树规范的设备树描述在系统中客户端程序不一定能动态检测到的设备信息。例如，PCI的体系结构使客户程序能够测试和检测连接的设备，因此可能不需要描述PCI设备的设备树节点。但是，如果无法探测和检测到则需要设备节点来描述系统中的PCI主桥设备。

**示例**
图2.1显示了一个简单设备树的示例表示，该设备树几乎完全足以启动简单的操作系统，具有平台类型、CPU、内存和单个UART。 每个节点内都有属性和值。

![1](https://www.github.com/liao20081228/blog/raw/master/图片/设备树规范v0.2/1.JPG)

## 2.2 设备树结构和约定
### 2.2.1 节点名称
**节点名称要求**

设备树中的每个节点都根据以下约定命名：

&emsp;node-name@unit-address

node-name指定节点的名称。 它的长度应为（shall）1到31个字符，仅由表2.1中的字符集中的字符组成。

 ![3](https://www.github.com/liao20081228/blog/raw/master/图片/设备树规范v0.2/3.JPG)
 
node-name必须（shall）以小写或大写字符开头，并应（should）描述设备的通用类别。
 
unit-address特指节点所在的总线类型。它由表2.1中的一个或多个ASCII字符组成。unit-address必须与节点的reg属性中指定的第一个地址匹配。 如果节点没有reg属性，则必须省略@unit-address，并且node-name单独将节点与树中同一级别的其他节点区分开来。 特定总线的绑定（binding）可能（may）对reg和unit-address的格式指定更多，更具体的要求。

根节点没有node-name或unit-address。 它由正斜杠（/）标识。

![4](https://www.github.com/liao20081228/blog/raw/master/图片/设备树规范v0.2/4.JPG)

在图2.2中：

* 名称为cpu的节点按其单元（cell）地址值0和1进行区分。
* 名称为ethernet的节点通过其单元（cell）地址值Fe002000和Fe003000进行区分。

### 2.2.2 通用名称建议
节点的名称应该（should）是通用的，反映了设备的功能而不是其精确的编程模型。 如果合适，名称应该（should）是以下选项之一：

* adc
* accelerometer
* atm
* audio-codec
* audio-controller
* backlight
* bluetooth
* bus
* cache-controller
* camera
* can
* charger
* clock
* clock-controller
* compact-flash
* can
* cpu
* cpus
* crypto
* disk
* display
* dma-controller
* dsp
* eeprom
* efuse
* endpoint
* ethernet
* ethernet-phy
* fdc
* flash
* gpio
* gpu
* gyrometer
* hdmi
* i2c
* ide
* interrupt-controller
* isa
* keyboard
* key
* keys
* lcd-controller
* led
* leds
* led-controller
* light-sensor
* magnetometer
* mailbox
* mdio
* memory
* memory-controller
* mmc
* mmc-slot
* mouse
* nand-controller
* nvram
* oscillator
* parallel
* pc-card
* pci
* pcie
* phy
* pinctrl
* pmic
* pmu
* port
* ports
* pwm
* regulator
* reset-controller
* rtc
* sata
* scsi
* serial
* sound
* spi
* sram-controller
* ssi-controller
* syscon
* temperature-sensor
* timer
* touchscreen
* usb
* usb-hub
* usb-phy
* video-codec
* vme
* watchdog
* wifi
###  2.2.3 路径名称
通过指定从根节点经过所有后代节点到目标节点的完整路径，可以唯一地识别设备树中的节点。

指定设备路径的约定是：

&emsp;/node-name-1/node-name-2/node-name-N

例如，在图2.2中，cpu＃1的设备路径为：

&emsp;/cpus/cpu@1

根节点的路径是/。

如果节点的完整路径是明确的，则可以省略单元（cell）地址。

如果客户程序遇到不明确的路径，则其行为未定义。

### 2.2.4 属性
设备树中的每个节点都具有描述节点特征的属性。 属性由名称和值组成。

**属性名称**

属性名称是由表2.2中的字符组成的长度为1到31的字符串。

![5](https://www.github.com/liao20081228/blog/raw/master/图片/设备树规范v0.2/5.JPG)

非标准属性名称应指定唯一的字符串前缀，例如股票代码，标识定义属性的公司或组织的名称。例子：

&emsp;&emsp;fsl,channel-fifo-len
&emsp;&emsp;ibm,ppc-interrupt-server#s
&emsp;&emsp;linux,network-index**

**属性值**
属性值是零个或多个字节的数组，其中包含与属性关联的信息。

如果为真假信息，则属性可能（may）为空值。 在这种情况下，该属性是否存就足够描述了。

表2.3描述了DTSpec定义的基本值类型。

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;表2.3 属性值
|值|描述|
|：--|：--|
|\<empty\>|值为空。 属性本身是否存在就足以用于传达真假信息。
|\<u32\>|大端模式的32位整数。 例如：  0x11223344 在内存表示为：<br />&emsp;&emsp;&emsp;address 11<br />&emsp;&emsp;address+1 22<br />&emsp;&emsp;address+2 33<br />&emsp;&emsp;address+3 44
|\<64\>|大端模式的64位整数。 由两个u32值组成，其中第一个值包含高有效位，第二个值包含低有效位。示例：64位值0x1122334455667788将表示为两个单元（cell）格：\<0x11223344 0x55667788\>。该值将在内存中表示为：<br />&emsp;&emsp;&emsp;address 11<br />&emsp;&emsp;address+1 22<br />&emsp;&emsp;address+2 33<br />&emsp;&emsp;address+3 44<br />&emsp;&emsp;address+4 55<br />&emsp;&emsp;address+5 66<br />&emsp;&emsp;address+6 77<br />&emsp;&emsp;address+7 88<br />&emsp;&emsp;
|\<string\>|字符串可打印，并且以null结尾。 示例：字符串“hello”将在内存中表示为：<br />&emsp;&emsp;&emsp;address 68 'h'<br />&emsp;&emsp;address+1 65 'e'<br />&emsp;&emsp;address+2 6C 'l'<br />&emsp;&emsp;address+3 6C 'l'<br />&emsp;&emsp;address+4 6F 'o'<br />&emsp;&emsp;address+5 00 '\0'
|\<prop-encoded-array>|特定属性格式 。 请参阅属性定义。|
|\<phandle\>|一个u32值。 一个phandle值是在设备树中引用另一个节点的一种方法。可以引用的任何节点都定了具有唯一的u32值的phandle属性。该数字用于具有phandle值类型的属性的值。
|\<stringlist> |字符串列表。例如：字符串列表 “hello”,”world” 将在内存中表示为：<br />&emsp;&emsp;&emsp;address 68 'h'<br />&emsp;&emsp;address+1 65 'e'<br />&emsp;&emsp;address+2 6C 'l'<br />&emsp;&emsp;address+3 6C 'l'<br />&emsp;&emsp;address+4 6F 'o'<br />&emsp;&emsp;address+5 00 '\0'<br />&emsp;&emsp;address+6 77 'w'<br />&emsp;&emsp;address+7 6f 'o'<br />&emsp;&emsp;address+8 72 'r'<br />&emsp;&emsp;address+9 6C 'l'<br />&emsp;&emsp;address+10 64 'd'<br />&emsp;&emsp;address+11 00 '\0'<br />&emsp;&emsp;

## 2.3 标准属性
DTSpec为设备节点指定一组标准属性。 本节将详细介绍这些属性。DTSpec定义的设备节点（参见第3章）可以（may）指定有关标准属性使用的附加要求或约束。 第4章描述了特定设备的表示，还可以（may）指定其他要求。

>注意：本文档中设备树节点的所有示例都使用DTS格式来指定节点和属性。

### 2.3.1 compatible
**属性名**：compatible
**值类型**：\<stringlist>
**描&emsp;述**：

* compatible属性由定义设备的特定编程模型的一个或多个字符串组成。客户端程序应（should）使用此字符串列表来选择设备驱动程序。属性值由一系列以null结尾的字符串构成，从特殊到一般。它们允许设备表达与一系列类似设备的兼容性，可能允许单个设备驱动程序与多个设备匹配。

* 推荐的格式是 "manufacturer,model"，其中manufacturer是描述制造商名称的字符串（比如股票代码），model指定模型型号。

**示&emsp;例**：
&emsp;&emsp;compatible = "fsl,mpc8641", "ns16550";
在此示例中，操作系统将首先尝试查找支持fsl，mpc8641的设备驱动程序。 如果没有找到，那么将尝试查找支持一般的ns16550设备类型的驱动。


### 2.3.2 model
**属性名**：modle
**值类型**：\<string>
**描&emsp;述**：

* model属性值是一个字符串，用于指定制造商的设备型号。

* 推荐的格式是“制造商，型号”，其中制造商是描述制造商名称的字符串（比如股票代码），型号指定模型型号。

**示&emsp;例**：
&emsp;&emsp;model = "fsl,MPC8349EMITX";

###  2.3.3 phandle
**属性名**：phandle
**值类型**：\<u32>
**描&emsp;述**：phandle属性为设备树中的唯一节点制定了数字化的标识符。phandle属性的值是被其它需要引用该节点的节点在与相应的属性值处使用。
**示&emsp;例**：请参阅以下设备树片段：
```dts
pic@10000000 {
phandle = <1>;
interrupt-controller;
};
```
定义了一个为1的phandle。 另一个设备节点可以引用具有值为1的phandle的pic节点：
```dts
another-device-node {
interrupt-parent = <1>;
};
```
>注意：旧版本的设备树可能会遇到叫做 linux，phandle的属性，它其实是phandle的弃用形式。 为了兼容性，如果没有phandle属性，客户程序可能支持linux，phandle。 这两个属性的含义和用法是相同的。

>注意：DTS中的大多数设备树（参见附录A）不包含显式的phandle属性。 当DTS编译为二进制DTB格式时，DTC工具会自动插入phandle属性。

### 2.3.4 status

**属性名**： status
**值类型**：\<string>
**描&emsp;述**：status属性指示设备的运行状态。 下表中列出并定义了有效值

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;表 2.4： status 属性的值
|值 |描述|
|：--|：--|
|"okay" |表示设备正在运行l
|"disabled"|表示设备目前没有运行，但未来可以运行（例如插入或关掉了什么东西） ，有关给定设备的禁用方法的详细信息，请参阅设备绑定（binding）。
|"fail" |表示设备无法运行。 设备中检测到严重错误，未经修复就不可能运行。
|"fail-sss" |表示设备无法运行。 在设备中检测到严重错误，未经修复就不可能运行。 值的sss部分特定于设备并指示检测到的错误原因。


### 2.3.5 #address-cells and #size-cells
**属性名**： #address-cells，#size-cells
**值类型**：\<u32>
**描&emsp;述**：
* #address-cells和#size-cells属性可用于在设备树层次结构中具有子节点的任何设备节点，并描述应如何寻址子设备节点。#address-cells属性定义用于编码子节点的reg属性的地址字段的\<u32>单元（cell）的数量。#size-cells属性定义用于对子节点的reg属性中的size字段进行编码的\<u32>单元（cell）的数量。

* ＃address-cells和＃size-cells属性不是从设备树中的祖先继承的。 它们应明确定义。

* 符合DTSpec标准的引导程序应在所有有子节点的节点上提供＃address-cells和＃size-cells。 如果缺少，客户端程序应该对＃address-cells假定默认值为2，对于#size-cells应该为1。

**示&emsp;例**：请参阅以下设备树片段：
```dts
soc {
	#address-cells = <1>;
	#size-cells = <1>;
	serial {
		compatible = "ns16550";
		reg = <0x4600 0x100>;
		clock-frequency = <0>;
		interrupts = <0xA 0x8>;
		interrupt-parent = <&ipic>;
	};
};
```
在此示例中，soc节点的＃address-cells和#size-cells属性都设置为1。此设置指定需要一个单元（cell）来表示子节点的reg属性中的地址，并且需要一个单元（cell）来表示子节点的reg属性中的大小。 

串行设备reg属性必须遵循父节点（soc）中设置的规范——地址由1个单元（cell）（0x4600）表示，大小由1个单元（cell）（0x100）表示。

### 2.3.6 reg
**属性名**：reg
**值类型**：\<prop-encoded-array> 编码为任意数量的（地址，长度）对。
**描&emsp;述**：
* reg属性描述了由其父总线定义的地址空间内的设备资源的地址。最常见的是，这意味着内存映射IO寄存器块的偏移量和长度，但在某些总线类型上可能有不同的含义。 根节点定义的地址空间中的地址是CPU实际地址。

* 该属性的值是<prop-encoded-array>，由任意数量的地址和长度对组成，\<地址 长度>。指定地址和长度所需的\、\<u32>单元（cell）的数量是特定于总线的，并由设备节点的父节点中的#address-cells和#size-cells属性指定。 如果父节点为#size-cells指定值0，则应省略reg值的长度字段。

**示&emsp;例**：假设SoC的器件有两个寄存器块，32字节块在SoC中偏移量为0x3000，256字节块的偏移量为0xFE00。 reg属性将编码如下（假设＃address-cells和＃size-cells值为1）：
&emsp;&emsp;reg = <0x3000 0x20 0xFE00 0x100>;


### 2.3.7 virtual-reg
**属性名**：virtual-reg
**值类型**：\<u32>
**描&emsp;述**：virtual-reg属性指定一个有效地址，该地址映射到设备节点的reg属性中指定的第一个物理地址。 此属性使引导程序能够为客户程序提供已设置的虚拟地址到物理地址的映射。

### 2.3.8 ranges

**属性名**：ranges
**值类型**：\<empty>或\<prop-encoded-array>编码为任意数量的（子总线地址，父总线地址，长度）三元组。
**描&emsp;述**：
* ranges属性提供了一种定义总线地址空间（子地址空间）和总线节点的父节点的地址空间（父地址空间）之间的映射或转换的方法。

* ranges属性值的格式是任意数量的（子总线地址，父总线地址，长度）三元组。

	* 子总线地址是子总线地址空间中的物理地址。 表示地址的单元（cell）数取决于总线，可以从该节点（出现ranges属性的节点）的#address-cells确定。
	* 父总线地址是父总线地址空间内的物理地址。 表示父地址的单元数（cell）取决于总线，可以从定义父地址空间的节点的＃address-cells属性中确定。
	* 长度是子地址空间中的范围的大小。 表示大小的单元数可以从该节点（出现ranges属性的节点）的#size-cells确定。

* 如果使用\<empty>值定义属性，则它指定父地址空间和子地址空间相同，并且不需要地址转换。

* 如果该属性不存在于总线节点中，则假定该节点的子节点与父地址空间之间不存在映射。

**示&emsp;例**：
```dts
soc {
	compatible = "simple-bus";
	#address-cells = <1>;
	#size-cells = <1>;
	ranges = <0x0 0xe0000000 0x00100000>;
	serial {
		device_type = "serial";
		compatible = "ns16550";
		reg = <0x4600 0x100>;
		clock-frequency = <0>;
		interrupts = <0xA 0x8>;
		interrupt-parent = <&ipic>;
	};
};
```
soc节点指定一个ranges属性：

&emsp;&emsp;<0x0 0xe0000000 0x00100000>;

此属性值指定了1024KB的地址空间范围，在子节点的物理地址0x0处寻址时映射到父节点的物理地址0xe0000000。通过此映射，serial设备节点可以通过在地址0xe0004600处的载入或存储来被寻址，0xe0004600为子地址空间中的偏移量为0x4600（在reg中指定）加上ranges中映射的父地址0xe0000000。

### 2.3.9 dma-ranges

**属性名**：dma-ranges
**值类型**：\<empty>或\<prop-encoded-array>编码为任意数量的（子总线地址，父总线地址，长度）三元组。
**描&emsp;述**：


**示&emsp;例**：


**属性名**：dma-ranges
**值类型**：\<empty>或\<prop-encoded-array>编码为任意数量的（子总线地址，父总线地址，长度）三元组。
**描&emsp;述**：
* dma-ranges属性用于描述内存映射总线的直接内存访问（DMA）结构，其设备树父节点可以从源自总线的DMA操作访问。它提供了一种定义总线的物理地址空间和总线父节点的物理地址空间之间的映射或转换的方法。

* dma-ranges属性值的格式是任意数量的（子总线地址，父总线地址，长度）三元组。每个三元组特定描述连续的DMA地址范围。

	* 子总线地址是子总线地址空间中的物理地址。 表示地址的单元（cell）数取决于总线，可以从该节点（出现dma-ranges属性的节点）的#address-cells确定。
	* 父总线地址是父总线地址空间内的物理地址。 表示父地址的单元数（cell）取决于总线，可以从定义父地址空间的节点的＃address-cells属性中确定。
	* 长度是子地址空间中的范围的大小。 表示大小的单元数可以从该节点（出现dma-ranges属性的节点）的#size-cells确定。

### 2.3.10 name（弃用）
**属性名**：name
**值类型**：\<string>
**描&emsp;述**：name属性是一个指定节点名称的字符串。 此属性已经废弃，不建议使用它。 但是，它可能用于较旧的非DTSpec兼容的设备。 操作系统应根据节点名称的node-name字段确定节点的名称（请参阅第2.2.1节）。

### 2.3.11 device_type (弃用)
**属性名**： device_type
**值类型**：\<string>
**描&emsp;述**：在IEEE 1275中使用device_type属性来描述设备的FCode编程模型。 由于DTSpec没有FCode，因此不推荐使用该属性，并且只应将其包含在cpu和内存节点上，以便与IEEE 1275派生的设备树兼容。

## 2.4 中断与中断映射

DTSpec采用在Open Firmware Recommended Practice： Interrupt Mapping, Version 0.9 [^b7]中指定的表示中断的中断树模型。在设备树内，存在逻辑中断树，其表示平台硬件中的中断的层次结构和中断路径。 虽然通常称为中断树，但它在技术上实际是有向无环图。

[^b7]:Open Firmware Recommended Practice： Interrupt Mapping, Version 0.9, Open Firmware Working Group, 1996(http://playground.sun.com/1275/practice/imap/imap0_9d.pdf)

中断源到中断控制器的物理连线在设备树中用interrupt-parent属性表示。表示产生中断的设备的节点包含一个interrupt-parent属性，该属性的phandle值指向设备的中断路由到的设备，通常是一个中断控制器。 如果中断生成设备没有interrupt-parent属性，则假定其中断父设备是其设备树中的父设备。

每个中断生成设备包含一个interrupts属性，其值描述该设备的一个或多个中断源。每个中断源都用称为中断说明符的信息表示。中断说明符的格式和含义是特定于中断域的，它取决于中断域根节点上的属性。＃interrupt-cells属性由中断域的根节点用于定义编码中断说明符所需的\<u32>值的数量。例如，对于Open PIC中断控制器，中断说明符采用两个32位值表示，并由中断编号和中断的电平/敏感信息组成。

中断域是解释中断说明符的上下文。 中断域的根节点是一个中断控制器（interrupt controller）或中断连接（interrupt nexus）。

* 中断控制器是物理设备，需要驱动程序来处理路由到它的中断。它也可以级联到另一个中断域。中断控制器由设备树中该节点上的interrupt-controller属性指定。
* 中断连接（interrupt nexus）定义了一个中断域与另一个中断域之间的转换。转换基于特定中断域的信息和特定总线的信息。中断域之间的这种转换是使用interrupt-map属性执行的。例如，PCI控制器设备节点可以是定义从PCI中断命名空间（INTA，INTB等）到具有中断请求号（IRQ）的中断控制器的转换的中断连接。

当遍历中断树到达一个没有 interrupts属性和显式中断父节点的中断控制器节点时，他就被确定为中断树的根节点。

有关设备树中的中断父关系的图形表示，请参见图2.3。它显示了设备树的自然结构以及每个节点在逻辑中断树中的位置。

![6](https://www.github.com/liao20081228/blog/raw/master/图片/设备树规范v0.2/6.JPG)

在图2.3所示的示例中：

*  open-pic中断控制器是中断树的根。
*  中断树根节点有三个子设备，它们将中断直接路由到open-pic
	*   device1
	*   PCI host controller
	*   GPIO Controller
*   存在三个中断域; 一个以open-pic节点为根，一个以pci-host节点为根，一个以gpioctrl节点为根。
*   有两个中断连接节点; 一个位于pci-host节点，一个位于gpioctrl节点。

###  2.4.1 中断生成设备的属性
**属性名**：interrupts
**值类型**：\<prop-encoded-array>编码为任意数量的中断说明符。
**描&emsp;述**：
* 设备节点的interrupts属性定义设备生成的中断。interrupts属性的值由任意数量的中断说明符组成。中断说明符的格式由中断域的根节点的绑定（binding）定义。

* interrupts会被 interrupts-extended属性覆盖，通常只应使用其中一种。

**示&emsp;例**：开放式PIC兼容中断域中的中断说明符的通用定义包括两个单元; 中断号和电平/敏感信息。请参阅以下示例，该示例定义了一个中断说明符，中断号为0xA，电平/敏感信息编码为8。

&emsp;&emsp;interrupts = \<0xA 8>;

**属性名**：interrupt-parent
**值类型**：\<phandle>
**描&emsp;述**：由于中断树中节点的层次结构可能与设备树中的节点层次结构不匹配，因此可以使用interrupt-parent属性显式定义中断父节点。该属性的值是中断父节点的phandle。 如果设备中缺少此属性，则假定其中断父节点是其设备树中的父节点。


**属性名**：interrupts-extended
**值类型**：\<phandle> \<prop-encoded-array>
**描&emsp;述**：interrupts-extended属性列出了设备生成的中断。当设备连接到多个中断控制器时，应使用interrupts-extended而不是interrupts，因为它使用每个中断说明符对父phandle进行编码。
**示&emsp;例**：这个例子展示了一个有两个中断输出连接到两个独立的中断控制器的设备如何使用interrupts-extended属性描述连接。pic是一个中断控制器，其#interrupt-cells属性为2，而gic是一个中断控制器，其#interruptts-cells属性为1。
&emsp;&emsp;interrupts-extended = <&pic 0xA 8>, <&gic 0xda>;

>interrupts和interrupts-extended属性是互斥的。 设备节点应使用其中一个。仅当需要与不理解interrupts-extended的软件兼容时，才允许使用两者。如果二者同时存在，则interrupts-extended优先。

### 2.4.2 中断控制器的属性

**属性名**：#interrupt-cells
**值类型**：\<u32>
**描&emsp;述**：＃interrupt-cells属性定义了编码中断域的中断说明符所需的单元(cell)数。



**属性名**：interrupt-controller
**值类型**：\<empty>
**描&emsp;述**：interrupt-controller属性把节点定义为中断控制器节点。

### 2.4.3 中断连接的属性

中断连接节点应该具有#interrupt-cells属性。

**属性名**：interrupt-map
**值类型**：\<prop-encoded-array> 编码为任意数量的中断映射条目。
**描&emsp;述**：
*  interrupt-map是中断连接（interrupt nexus）节点上的属性，它将一个中断域与一组父中断域桥接，并指定子域中的中断说明符如何映射到其各自的父中断域中。
*  中断映射是一个表，其中每一行是一个映射条目，由五个字段组成：子节点单元地址，子节点中断说明符，中断父节点，父节点单元地址，父节点中断说明符。
	*  **子节点单元地址** 要映射的子节点的单元地址。此字段所需的32位单元（cell）的数量由子节点所在的总线节点的#address-cells属性描述。
	*  **子节点中断说明符** 要映射的子节点的中断说明符。此字段所需的32位单元数由该节点（包含interrupt-map属性的nexus节点）的#interrupt-cells属性描述。
	*  **中断父节点** 单个\<phandle>值，指向子中断域要映射到的中断父节点。
	*  **父节点单元地址** 中断父节点的单元地址。 此字段所需的32位单元数由中断父节点字段指向的节点的#address-cells属性描述。
	*  **父节点中断说明符** 中断父节点的中断说明符。此字段所需的32位单元数由中断父节点字段指向的节点的#interrupt-cells属性描述。
* 在中断映射表上将单元地址/中断说明符对与中断映射中的字段进行匹配。由于单元中断说明符中的某些字段可能不相关，因此在查找完成之前应用掩码。 该掩码在interrupt-map-mask属性中定义（参见第2.4.3.2节）。
>注意：子中断节点和父中断节点都需要定义#address-cells和#interrupt-cells属性。 如果不需要单元地址字段，则#address-cells应明确定义为零。



**属性名**：interrupt-map-mask
**值类型**：\<prop-encoded-array> 编码为位掩码。
**描&emsp;述**：为中断树中的中断连接节点指定了interrupt-map-mask属性。此属性指定一个掩码，该掩码应用于在interrupt-map属性指定的表中查找的中断说明符时。


**属性名**：#interrupt-cells
**值类型**：\<u32>
**描&emsp;述**：＃interrupt-cells属性定义了编码中断域的中断说明符所需的单元(cell)数。


### 2.4.4 中断映射示例
下面显示了具有PCI总线控制器和一个中断映射的设备树片段，该中断映射用于描述两个PCI插槽（IDSEL 0x11,0x12）的中断路由。插槽1和2的INTA，INTB，INTC和INTD引脚连接到Open PIC中断控制器。

```dts
soc {
	compatible = "simple-bus";
	#address-cells = <1>;
	#size-cells = <1>;
	
	open-pic {
		clock-frequency = <0>;
		interrupt-controller;
		#address-cells = <0>;
		#interrupt-cells = <2>;
	};
	
	pci {
		#interrupt-cells = <1>;
		#size-cells = <2>;
		#address-cells = <3>;
		interrupt-map-mask = <0xf800 0 0 7>;
		interrupt-map = <
			/ * IDSEL 0x11 - PCI slot 1* /
			0x8800 0 0 1 &open-pic 2 1 / * INTA * /
			0x8800 0 0 2 &open-pic 3 1 / * INTB * /
			0x8800 0 0 3 &open-pic 4 1 / * INTC * /
			0x8800 0 0 4 &open-pic 1 1 / * INTD * /
			/ * IDSEL 0x12 - PCI slot 2* /
			0x9000 0 0 1 &open-pic 3 1 / * INTA * /
			0x9000 0 0 2 &open-pic 4 1 / * INTB * /
			0x9000 0 0 3 &open-pic 1 1 / * INTC * /
			0x9000 0 0 4 &open-pic 2 1 / * INTD * /
		>;
	};
};
```






**属性名**：dma-ranges
**值类型**：\<empty>
**描&emsp;述**：


**示&emsp;例**：

**属性名**：dma-ranges
**值类型**：\<empty>
**描&emsp;述**：


**示&emsp;例**：

**属性名**：dma-ranges
**值类型**：\<empty>
**描&emsp;述**：


**示&emsp;例**：

**属性名**：dma-ranges
**值类型**：\<empty>
**描&emsp;述**：


**示&emsp;例**：

------

&emsp;&emsp;<font color=blue>**_版权声明_**</font>：本文翻译自<font color=blue>[设备树官网](https://www.devicetree.org/)。</font><font color=red>未经作者允许，<font color=blue>严禁用于商业出版</font>，否则追究法律责任。网络转载请注明出处，这是对原创者的起码的尊重！！！</font>

------
