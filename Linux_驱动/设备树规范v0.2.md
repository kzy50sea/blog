---
title: 设备树规范v0.2
tags: Linux内核
---

------

&emsp;&emsp;<font color=blue>**_版权声明_**</font>：本文翻译自<font color=blue>[设备树官网](https://www.devicetree.org/)。</font><font color=red>未经作者允许，<font color=blue>严禁用于商业出版</font>，否则追究法律责任。网络转载请注明出处，这是对原创者的起码的尊重！！！</font>

------

<style>table{word-break:initial;}</style>



# 5 扁平设备树（DTB）格式

设备树Blob（DTB）格式是设备树数据的平面二进制编码。 它用于在软件程序之间交换设备树数据。 例如，在引导操作系统时，固件会将DTB传递给OS内核。

>注意：IEEE1275开放固件[IEEE1275]未定义DTB格式。 在大多数符合Open Firmware的平台上，通过调用固件方法来提取设备树以遍历树结构。


DTB格式在单个线性无指针数据结构内对设备树数据进行编码。 它由一个header（见5.2节）和三个可变大小的部分组成：memory reservation block（见5.3节），structure block（见第5.4节）和strings block（见5.5节）。 这些应按顺序存在于扁平设备树中。 因此，当按地址处加载到内存中时，整个设备树结构将类似于图5.1中的图（较低地址位于图的顶部）。

![8](https://www.github.com/liao20081228/blog/raw/master/图片/设备树规范v0.2/8.JPG)

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;图5.1 设备树.dtb结构

free space 部分可能不存在，但在某些情况下，它们可能需要满足各个块的对齐约束（参见第5.6节）。


## 5.1版本控制
自DTB格式的原始定义以来，已经定义了几种版本的扁平设备树结构。 header中的字段给出版本，以便客户程序可以确定设备树是否以兼容格式编码。

本文档仅描述DTB格式的第17版。 符合DTSpec的引导程序应提供版本17或更高版本的设备树，并应提供与版本16向后兼容的版本的设备树。符合DTSpec标准的客户端程序应接受与版本17向后兼容的任何版本的设备树，并且也可以接受其他版本。

注意：版本是关于设备树的二进制结构，而不是其内容。

## 5.2 header
设备树的header布局由以下C结构定义。 所有头字段都是32位整数，以大端格式存储。

```c
struct fdt_header {
	uint32_t magic;
	uint32_t totalsize;
	uint32_t off_dt_struct;
	uint32_t off_dt_strings;
	uint32_t off_mem_rsvmap;
	uint32_t version;
	uint32_t last_comp_version;
	uint32_t boot_cpuid_phys;
	uint32_t size_dt_strings;
	uint32_t size_dt_struct;
};
```
**magic** This field shall contain the value 0xd00dfeed (big-endian)

**totalsize** This field shall contain the total size in bytes of the devicetree data structure. This size shall encompass all
sections of the structure: the header, the memory reservation block, structure block and strings block, as well as any
free space gaps between the blocks or after the final block.
off_dt_struct This field shall contain the offset in bytes of the structure block (see section 5.4) from the beginning
of the header.
off_dt_strings This field shall contain the offset in bytes of the strings block (see section 5.5) from the beginning
of the header.
off_mem_rsvmap This field shall contain the offset in bytes of the memory reservation block (see section 5.3) from
the beginning of the header.
version This field shall contain the version of the devicetree data structure. The version is 17 if using the structure as
defined in this document. An DTSpec boot program may provide the devicetree of a later version, in which case
this field shall contain the version number defined in whichever later document gives the details of that version.
last_comp_version Thisfieldshallcontainthelowestversionofthedevicetreedatastructurewithwhichtheversion
used is backwards compatible. So, for the structure as defined in this document (version 17), this field shall contain
16 because version 17 is backwards compatible with version 16, but not earlier versions. As per section 5.1, a
DTSpec boot program should provide a devicetree in a format which is backwards compatible with version 16, and
thus this field shall always contain 16.
boot_cpuid_phys This field shall contain the physical ID of the system’s boot CPU. It shall be identical to the
physical ID given in the reg property of that CPU node within the devicetree.
size_dt_strings This field shall contain the length in bytes of the strings block section of the devicetree blob.
size_dt_struct This field shall contain the length in bytes of the structure block section of the devicetree blob.

------

&emsp;&emsp;<font color=blue>**_版权声明_**</font>：本文翻译自<font color=blue>[设备树官网](https://www.devicetree.org/)。</font><font color=red>未经作者允许，<font color=blue>严禁用于商业出版</font>，否则追究法律责任。网络转载请注明出处，这是对原创者的起码的尊重！！！</font>

------
